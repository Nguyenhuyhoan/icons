name: Load Test with Random Free Proxy

on:
  workflow_dispatch: # Cho phÃ©p cháº¡y thá»§ cÃ´ng tá»« tab Actions

jobs:
  k6_load_test:
    name: Run k6 Load Test
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code tá»« repo cá»§a báº¡n
      - name: Checkout
        uses: actions/checkout@v4

      # Step 2: Äá»c danh sÃ¡ch proxy tá»« Secret vÃ  chá»n ngáº«u nhiÃªn má»™t cÃ¡i
      - name: Select a Random Proxy from the List
        id: select_proxy # Äáº·t ID Ä‘á»ƒ cÃ¡c step sau cÃ³ thá»ƒ tham chiáº¿u
        run: |
          # Äá»c danh sÃ¡ch proxy tá»« Secret vÃ o má»™t biáº¿n
          PROXY_LIST="${{ secrets.FREE_PROXY_LIST }}"
          
          # DÃ¹ng lá»‡nh `shuf -n 1` Ä‘á»ƒ chá»n ngáº«u nhiÃªn 1 dÃ²ng (1 proxy) tá»« danh sÃ¡ch
          SELECTED_PROXY=$(echo "$PROXY_LIST" | shuf -n 1)
          
          # Kiá»ƒm tra xem cÃ³ chá»n Ä‘Æ°á»£c proxy khÃ´ng
          if [ -z "$SELECTED_PROXY" ]; then
            echo "::error::Could not select a proxy from the list."
            exit 1
          fi
          
          # In ra proxy Ä‘Æ°á»£c chá»n Ä‘á»ƒ debug
          echo "Selected proxy for this run: $SELECTED_PROXY"
          
          # Xuáº¥t URL cá»§a proxy ra mÃ´i trÆ°á»ng cá»§a job Ä‘á»ƒ step sau sá»­ dá»¥ng
          echo "PROXY_URL=http://$SELECTED_PROXY" >> $GITHUB_ENV

      # Step 3: Cháº¡y k6 test vá»›i proxy Ä‘Ã£ Ä‘Æ°á»£c chá»n
      - name: Run k6 test
        uses: k6io/k6-action@v0.2.0
        with:
          script: ğŸ…¾ï¸script.js # ÄÆ°á»ng dáº«n tá»›i file k6 test cá»§a báº¡n
        env:
          # k6 sáº½ tá»± Ä‘á»™ng sá»­ dá»¥ng proxy Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong biáº¿n mÃ´i trÆ°á»ng nÃ y
          K6_HTTP_PROXY: ${{ env.PROXY_URL }}
