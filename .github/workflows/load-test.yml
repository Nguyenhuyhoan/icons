# .github/workflows/load-test.yml

name: Load Test with k6 Browser and Random Proxy
on:
  workflow_dispatch:

jobs:
  k6_load_test:
    name: Run k6 Browser Load Test
    runs-on: ubuntu-latest
    steps:
      # Bước 1: Checkout code từ repository
      - name: Checkout
        uses: actions/checkout@v4

      # Bước 2: Build k6 với extension bằng action "get-xk6" (ĐÂY LÀ PHIÊN BẢN ĐÚNG)
      # Action này được k6 khuyên dùng để build k6 với các extension (xk6)
      - name: Build k6 with xk6-browser extension
        uses: k6io/get-xk6@v0.5.0
        with:
          # Phiên bản k6 bạn muốn sử dụng
          version: v0.51.0
          # Danh sách các extension cần thêm vào
          extensions: |
            github.com/k6io/xk6-browser@latest
          # Tên file thực thi đầu ra, mặc định là 'k6' nên không cần ghi
          # output: ./k6

      # Bước 3: Chọn một Proxy ngẫu nhiên từ danh sách (Giữ nguyên)
      - name: Select a Random Proxy from the List
        id: select_proxy
        run: |
          PROXY_LIST="${{ secrets.FREE_PROXY_LIST }}"
          SELECTED_PROXY=$(echo "$PROXY_LIST" | shuf -n 1)
          if [ -z "$SELECTED_PROXY" ]; then
            echo "::error::Could not select a proxy from the list."
            exit 1
          fi
          echo "Selected proxy for this run: $SELECTED_PROXY"
          echo "PROXY_URL=http://$SELECTED_PROXY" >> $GITHUB_ENV

      # Bước 4: Chạy k6 test bằng file đã build (Giữ nguyên)
      - name: Run k6 test
        # Sử dụng file 'k6' đã được build ở Bước 2
        run: ./k6 run javascript/test.js
        env:
          # Truyền biến proxy cho k6-browser
          K6_BROWSER_PROXY: ${{ env.PROXY_URL }}
