
# .github/workflows/load-test.yml

name: Load Test with k6 Browser and Random Proxy (Manual Build)
on:
  workflow_dispatch:

jobs:
  k6_load_test:
    name: Run k6 Browser Load Test
    runs-on: ubuntu-latest
    steps:
      # Bước 1: Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # Bước 2: Cài đặt môi trường Go
      # Chúng ta cần Go để build k6 từ source
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21' # Phiên bản Go ổn định

      # Bước 3: Tự build k6 với extension (thay thế cho action get-xk6)
      - name: Manually build k6 with xk6-browser
        run: |
          echo "Installing xk6, the k6 extension builder..."
          go install go.k6.io/xk6/cmd/xk6@latest
          
          echo "Building k6 with xk6-browser extension..."
          # Lệnh này sẽ build k6 phiên bản v0.51.0 và thêm extension xk6-browser
          # File thực thi 'k6' sẽ được tạo trong thư mục hiện tại
          ~/go/bin/xk6 build v0.51.0 --with github.com/k6io/xk6-browser@latest

      # Bước 4: Chọn Proxy ngẫu nhiên
      - name: Select a Random Proxy from the List
        id: select_proxy
        run: |
          PROXY_LIST="${{ secrets.FREE_PROXY_LIST }}"
          SELECTED_PROXY=$(echo "$PROXY_LIST" | shuf -n 1)
          if [ -z "$SELECTED_PROXY" ]; then
            echo "::error::Could not select a proxy from the list."
            exit 1
          fi
          echo "Selected proxy for this run: $SELECTED_PROXY"
          echo "PROXY_URL=http://$SELECTED_PROXY" >> $GITHUB_ENV

      # Bước 5: Chạy k6 test bằng file k6 vừa build
      - name: Run k6 test
        run: ./k6 run javascript/test.js
        env:
          K6_BROWSER_PROXY: ${{ env.PROXY_URL }}
